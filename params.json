{"name":"Dokku-alt.git.push.deploy.problem","tagline":"Debugging Dokku-alt Git Push Deploy Problem ","body":"# Dokku-Alt.Git.Push.Deploy.Problem\r\nDebugging Dokku-alt Git Push Deploy Problem\r\n\r\nI wanted to make my public facing server __[a Dokku-alt server]__\r\nthat I could configure sites with\r\n\r\ngit push dokku master\r\n=====================\r\n\r\n```bash\r\n$ git clone https://github.com/heroku/node-js-sample\r\n$ cd node-js-sample\r\n$ git remote add dokku dokku@dokku-alt.com:node-js-app\r\n$ git push dokku master\r\nCounting objects: 296, done.\r\nDelta compression using up to 4 threads.\r\nCompressing objects: 100% (254/254), done.\r\nWriting objects: 100% (296/296), 193.59 KiB, done.\r\nTotal 296 (delta 25), reused 276 (delta 13)\r\n-----> Building node-js-app ...\r\n       Node.js app detected\r\n-----> Resolving engine versions\r\n\r\n... blah blah blah ...\r\n\r\n-----> Application deployed:\r\n       http://node-js-app.progriumapp.com\r\n```\r\n\r\nBut every single attempt has left me with this error\r\n-----------------------------------------\r\n\r\n```bash\r\n  My-MacBook-Pro:node-js-sample marchon$ git push dokku master\r\n  fatal: 'node-js-sample' does not appear to be a git repository\r\n  fatal: Could not read from remote repository.\r\n\r\n  Please make sure you have the correct access rights\r\n  and the repository exists.\r\n\r\n```\r\n\r\nI have been trying to make GIT PUSH DOKKU MASTER\r\nwork for deployment on dokku-alt from\r\n\r\nhttps://github.com/dokku-alt/dokku-alt\r\n\r\nI tried both this bash command, and cloning the repo locally\r\n\r\n```bash\r\n\r\n$ sudo bash -c \"$(curl -fsSL https://raw.githubusercontent.com/dokku-alt/dokku-alt/master/bootstrap.sh)\"\r\n\r\n```\r\n\r\nI Really \"Thought\" I had done something wrong\r\n============\r\n\r\nAfter Searching the web for solutions - and not being able to make any of them work, I finally reinstalled a fresh Ubuntu Server 14.04.\r\n\r\n__I was committed to making this work__\r\n\r\nSo... Just In Case:\r\n-------------\r\n\r\n* I downloaded and burnt a fresh Ubuntu 14.04 Server CD\r\n* I reconfigured the RAID Controller to split partitions and destroy the raid configuration\r\n* I repartitioned the Drives  \r\n* I installed a fresh Ubuntu Server 14.04 with choosing only SSH-Server as the install type\r\n\r\nThis server config is about as vanilla as you can get.\r\n------------------------------------------------------\r\n\r\nafter hours of making sure that it was not a \"bad configuration\"\r\n\r\nI faithfully re-executed the command\r\n\r\n```bash\r\n\r\n$ sudo bash -c \"$(curl -fsSL https://raw.githubusercontent.com/dokku-alt/dokku-alt/master/bootstrap.sh)\"\r\n\r\n```\r\n\r\n```bash\r\n  My-MacBook-Pro:node-js-sample marchon$ git push dokku master\r\n\r\n  fatal: 'node-js-sample' does not appear to be a git repository\r\n  fatal: Could not read from remote repository.\r\n\r\n  Please make sure you have the correct access rights\r\n  and the repository exists.\r\n\r\n```\r\n\r\nSo would appear that the repo does not exist.\r\n\r\nNext task - verify which RSA Identity Keys are being used.\r\n\r\nwith the command\r\n```bash\r\n\r\nbash-3.2# ssh -v dokku@dokku.lazarusco.in\r\n```\r\n\r\nWe can get SSH to tell us what is happening - the key information is which private key is SSH trying to use.\r\n\r\ndebug1: Trying private key: ___/var/root/.ssh/id_rsa__\r\ndebug1: read PEM private key done: type RSA\r\ndebug1: Authentication succeeded (publickey).\r\n\r\n\r\n```\r\n\r\nbash-3.2# ssh -v dokku@dokku.lazarusco.in\r\n  OpenSSH_6.2p2, OSSLShim 0.9.8r 8 Dec 2011\r\n  debug1: Reading configuration data /etc/ssh_config\r\n  debug1: /etc/ssh_config line 20: Applying options for *\r\n  debug1: /etc/ssh_config line 102: Applying options for *\r\n  debug1: Connecting to dokku.lazarusco.in [172.30.42.116] port 22.\r\n  debug1: Connection established.\r\n  debug1: permanently_set_uid: 0/0\r\n  debug1: identity file /var/root/.ssh/id_rsa type -1\r\n  debug1: identity file /var/root/.ssh/id_rsa-cert type -1\r\n  debug1: identity file /var/root/.ssh/id_dsa type -1\r\n  debug1: identity file /var/root/.ssh/id_dsa-cert type -1\r\n  debug1: Enabling compatibility mode for protocol 2.0\r\n  debug1: Local version string SSH-2.0-OpenSSH_6.2\r\n  debug1: Remote protocol version 2.0, remote software version OpenSSH_6.6.1p1 Ubuntu-2ubuntu2\r\n  debug1: match: OpenSSH_6.6.1p1 Ubuntu-2ubuntu2 pat OpenSSH*\r\n  debug1: SSH2_MSG_KEXINIT sent\r\n  debug1: SSH2_MSG_KEXINIT received\r\n  debug1: kex: server->client aes128-ctr hmac-md5-etm@openssh.com none\r\n  debug1: kex: client->server aes128-ctr hmac-md5-etm@openssh.com none\r\n  debug1: SSH2_MSG_KEX_DH_GEX_REQUEST(1024<1024<8192) sent\r\n  debug1: expecting SSH2_MSG_KEX_DH_GEX_GROUP\r\n  debug1: SSH2_MSG_KEX_DH_GEX_INIT sent\r\n  debug1: expecting SSH2_MSG_KEX_DH_GEX_REPLY\r\n  debug1: Server host key: RSA 8b:c8:61:91:4b:6e:5f:13:ea:7c:14:27:69:b0:f3:c0\r\n  debug1: Host 'dokku.lazarusco.in' is known and matches the RSA host key.\r\n  debug1: Found key in /var/root/.ssh/known_hosts:11\r\n  debug1: ssh_rsa_verify: signature correct\r\n  debug1: SSH2_MSG_NEWKEYS sent\r\n  debug1: expecting SSH2_MSG_NEWKEYS\r\n  debug1: SSH2_MSG_NEWKEYS received\r\n  debug1: Roaming not allowed by server\r\n  debug1: SSH2_MSG_SERVICE_REQUEST sent\r\n  debug1: SSH2_MSG_SERVICE_ACCEPT received\r\n  debug1: Authentications that can continue: publickey,password\r\n  debug1: Next authentication method: publickey\r\n\r\n  debug1: Trying private key: /var/root/.ssh/id_rsa\r\n\r\n  debug1: read PEM private key done: type RSA\r\n  debug1: Authentication succeeded (publickey).\r\n  Authenticated to dokku.lazarusco.in ([172.30.42.116]:22).\r\n  debug1: channel 0: new [client-session]\r\n  debug1: Requesting no-more-sessions@openssh.com\r\n  debug1: Entering interactive session.\r\n  debug1: Sending environment.\r\n  debug1: Sending env LANG = en_US.UTF-8\r\n  Welcome to Ubuntu 14.04.2 LTS (GNU/Linux 3.16.0-30-generic x86_64)\r\n\r\n   * Documentation:  https://help.ubuntu.com/\r\n\r\n    System information as of Thu Feb 26 20:00:27 EST 2015\r\n\r\n    System load:  0.0                Users logged in:        1\r\n    Usage of /:   16.2% of 29.21GB   IP address for eth0:    172.30.42.116\r\n    Memory usage: 7%                 IP address for docker0: 172.17.42.1\r\n    Swap usage:   0%                 IP address for lxcbr0:  10.0.3.1\r\n    Processes:    143\r\n\r\n```\r\n\r\nWe have verified that\r\n\r\n* SSH Connection started\r\n* the username is correct  \r\n* which public/private key pair is \"Actually\" being used\r\n\r\nWe have confirmed that it is not the ssh keys\r\n\r\n```bash\r\nbash-3.2# git push dokku master\r\n  fatal: 'node-js-sample' does not appear to be a git repository\r\n  fatal: Could not read from remote repository.\r\n\r\n  Please make sure you have the correct access rights\r\n  and the repository exists.\r\n```\r\n\r\nso lets push the public key again on the server so that there can be no confusion.\r\n\r\n```bash\r\n\r\nmarchon@Modulo:~$ echo \"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC9lYDU1bxZaDCRSk7yTZqBvWy1h2vqa9haS3W2OV/16MXnuhip+/qEWDMBxb/PAWjXPDDPpoFYJBCM6C5gmLkvRa1mZsFfRP98cdDZoJHCquQDDon/GqvjQghnRt/RH8dmuMPa4MGLoXjQ4ss4xGUOuWq+OcDrUHt4MjeYoLcQIaXJRwVq9tQWPjfoe4Suv488EesE39fjcefkXCXWMkYZ+kXoYoNfW/KwzPieAGU2PdbM7E8ovWFSufAcQva1cBD69UcjjLpUEc6Nx959A0yI4Zh+iuZbBG2HbeCJMxC042985eo98SlOWLt1As9G3C4Demh8UJnoAMHoGOR1Kael root@Rhondas-MacBook-Pro.local\" | dokku access:add\r\n-----> e9:96:ed:cf:eb:fc:53:2b:72:75:0f:7c:cc:ec:5f:3c added as an admin\r\n\r\n```\r\nOne last push to confirm that I do not think it is a key problem\r\n------------------------------\r\n\r\n\r\n```bash\r\nbash-3.2# git push dokku master\r\n  fatal: 'node-js-sample' does not appear to be a git repository\r\n  fatal: Could not read from remote repository.\r\n\r\n  Please make sure you have the correct access rights\r\n  and the repository exists.\r\n```\r\n\r\nI created the repo on the server\r\n\r\n```bash\r\n\r\nmarchon@Modulo:~$ dokku create node-js-sample\r\n-----> Application node-js-sample created!\r\n\r\n```\r\n\r\nand now we have a new error. ___   ! [remote rejected] master -> master (pre-receive hook declined)____\r\n\r\n```bash\r\nbash-3.2# git push dokku master\r\n  Counting objects: 378, done.\r\n  Delta compression using up to 8 threads.\r\n  Compressing objects: 100% (307/307), done.\r\n  Writing objects: 100% (378/378), 211.25 KiB | 0 bytes/s, done.\r\n  Total 378 (delta 42), reused 378 (delta 42)\r\n  remote: Access denied. No user supplied.\r\n  To dokku@dokku.lazarusco.in:node-js-sample\r\n   ! [remote rejected] master -> master (pre-receive hook declined)\r\n  error: failed to push some refs to 'dokku@dokku.lazarusco.in:node-js-sample'\r\n\r\n\r\n```\r\n\r\nat the suggestion of http://progrium.viewdocs.io/dokku/troubleshooting\r\n\r\nI have added to /home/dokku/dokkurc\r\n```\r\nexport DOKKU_TRACE=1\r\n```\r\n\r\nAnd now we have more debug information:\r\n\r\n```\r\nbash-3.2# git push dokku master\r\n  Counting objects: 378, done.\r\n  Delta compression using up to 8 threads.\r\n  Compressing objects: 100% (307/307), done.\r\n  Writing objects: 100% (378/378), 211.25 KiB | 0 bytes/s, done.\r\n  Total 378 (delta 42), reused 378 (delta 42)\r\n  remote: +++ [[ -z /home/dokku ]]\r\n  remote: +++++ dirname /var/lib/dokku-alt/plugins/acl/verify-command\r\n  remote: ++++ cd /var/lib/dokku-alt/plugins/acl\r\n  remote: ++++ pwd\r\n  remote: +++ CWD=/var/lib/dokku-alt/plugins/acl\r\n  remote: ++ AUTHORIZED_KEYS=/home/dokku/.ssh/authorized_keys\r\n  remote: ++ DEPLOY_ALLOWED=DEPLOY_ALLOWED\r\n  remote: + cat\r\n  remote: + [[ -z '' ]]\r\n  remote: ++ id -un\r\n  remote: + [[ dokku != \\r\\o\\o\\t ]]\r\n  remote: + fail 'Access denied. No user supplied.'\r\n  remote: + echo 'Access denied. No user supplied.'\r\n  remote: Access denied. No user supplied.\r\n  remote: + exit 1\r\n  To dokku@dokku.lazarusco.in:node-js-sample\r\n   ! [remote rejected] master -> master (pre-receive hook declined)\r\n  error: failed to push some refs to 'dokku@dokku.lazarusco.in:node-js-sample'\r\n```\r\n\r\nand now I had to learn about __SSHCOMMAND__\r\n\r\nThe documentation is not very clear - and it took me a while to wrap my head around it - but:\r\n\r\nSSHCOMMAND is used to create a USERPROFILE on the server that will execute remote commands when authorized by a public/private key pair that has been authorized to execute that command.\r\n\r\nThis works because your Public/Private key pair is not specific to your username - but in fact will work for any user name on a machine that is willing to accept it as credentials.\r\n\r\nso if we want to run a command we are going to remotely alias as LS\r\n\r\nwe use the following command on the server\r\n\r\n```\r\nsshcommand create [NAME_OF_NEW_REMOTE_COMMAND] [SYNTAX]\r\nsshcommand create LS                           \"/bin/ls -lR /\"\r\n```\r\nthe actual command syntax for ___sshcommand create___\r\n------\r\n\r\n```bash\r\nroot@Modulo:~# sshcommand create LS \"/bin/ls -lR /\"  \r\n```\r\nwhen we use this sshcommand create it has the effect of:\r\n\r\n* define a new user - called LS\r\n* and makes the server execute the command syntax when that user logs in\r\n\r\nNext sshcommand needs to link authorized users to these remote commands via Public/Private key pair\r\n\r\n\r\n```bash\r\n\r\nroot@Modulo:~# cat id_rsa.pub  |  sshcommand acl-add LS boo\r\n  e9:96:ed:cf:eb:fc:53:2b:72:75:0f:7c:cc:ec:5f:3c\r\n```\r\n\r\nwhen ssh connects as user LS with a valid key pair the command is executed.\r\n\r\non macbook this command will login to the Server as user LS and my private key. It will then execute command and the results will stream back over the SSH chonnection\r\n\r\n```\r\n\r\nssh -v LS@dokku.lazarusco.in\r\n\r\n```\r\n\r\nit would appear that the sshcommand bindings around the git push are incorrect.\r\n\r\n\r\nBut solving that is a problem for tomorrow.  \r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}