<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Dokku-alt.git.push.deploy.problem by marchon</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Dokku-alt.git.push.deploy.problem</h1>
        <p class="header">Debugging Dokku-alt Git Push Deploy Problem </p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/marchon/Dokku-Alt.Git.Push.Deploy.Problem/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/marchon/Dokku-Alt.Git.Push.Deploy.Problem/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/marchon/Dokku-Alt.Git.Push.Deploy.Problem">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/marchon">marchon</a></p>


      </header>
      <section>
        <h1>
<a id="dokku-altgitpushdeployproblem" class="anchor" href="#dokku-altgitpushdeployproblem" aria-hidden="true"><span class="octicon octicon-link"></span></a>Dokku-Alt.Git.Push.Deploy.Problem</h1>

<p>Debugging Dokku-alt Git Push Deploy Problem</p>

<p>I wanted to make my public facing server <strong>[a Dokku-alt server]</strong>
that I could configure sites with</p>

<h1>
<a id="git-push-dokku-master" class="anchor" href="#git-push-dokku-master" aria-hidden="true"><span class="octicon octicon-link"></span></a>git push dokku master</h1>

<div class="highlight highlight-bash"><pre>$ git clone https://github.com/heroku/node-js-sample
$ <span class="pl-s3">cd</span> node-js-sample
$ git remote add dokku dokku@dokku-alt.com:node-js-app
$ git push dokku master
Counting objects: 296, <span class="pl-k">done</span>.
Delta compression using up to 4 threads.
Compressing objects: 100% (254/254), <span class="pl-k">done</span>.
Writing objects: 100% (296/296), 193.59 KiB, <span class="pl-k">done</span>.
Total 296 (delta 25), reused 276 (delta 13)
-----<span class="pl-k">&gt;</span> Building node-js-app ...
       Node.js app detected
-----<span class="pl-k">&gt;</span> Resolving engine versions

... blah blah blah ...

-----<span class="pl-k">&gt;</span> Application deployed:
       http://node-js-app.progriumapp.com</pre></div>

<h2>
<a id="but-every-single-attempt-has-left-me-with-this-error" class="anchor" href="#but-every-single-attempt-has-left-me-with-this-error" aria-hidden="true"><span class="octicon octicon-link"></span></a>But every single attempt has left me with this error</h2>

<div class="highlight highlight-bash"><pre>  My-MacBook-Pro:node-js-sample marchon$ git push dokku master
  fatal: <span class="pl-s1"><span class="pl-pds">'</span>node-js-sample<span class="pl-pds">'</span></span> does not appear to be a git repository
  fatal: Could not <span class="pl-s3">read</span> from remote repository.

  Please make sure you have the correct access rights
  and the repository exists.
</pre></div>

<p>I have been trying to make GIT PUSH DOKKU MASTER
work for deployment on dokku-alt from</p>

<p><a href="https://github.com/dokku-alt/dokku-alt">https://github.com/dokku-alt/dokku-alt</a></p>

<p>I tried both this bash command, and cloning the repo locally</p>

<div class="highlight highlight-bash"><pre>
$ sudo bash -c <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-s1"><span class="pl-pds">$(</span>curl -fsSL https://raw.githubusercontent.com/dokku-alt/dokku-alt/master/bootstrap.sh<span class="pl-pds">)</span></span><span class="pl-pds">"</span></span>
</pre></div>

<h1>
<a id="i-really-thought-i-had-done-something-wrong" class="anchor" href="#i-really-thought-i-had-done-something-wrong" aria-hidden="true"><span class="octicon octicon-link"></span></a>I Really "Thought" I had done something wrong</h1>

<p>After Searching the web for solutions - and not being able to make any of them work, I finally reinstalled a fresh Ubuntu Server 14.04.</p>

<p><strong>I was committed to making this work</strong></p>

<h2>
<a id="so-just-in-case" class="anchor" href="#so-just-in-case" aria-hidden="true"><span class="octicon octicon-link"></span></a>So... Just In Case:</h2>

<ul>
<li>I downloaded and burnt a fresh Ubuntu 14.04 Server CD</li>
<li>I reconfigured the RAID Controller to split partitions and destroy the raid configuration</li>
<li>I repartitioned the Drives<br>
</li>
<li>I installed a fresh Ubuntu Server 14.04 with choosing only SSH-Server as the install type</li>
</ul>

<h2>
<a id="this-server-config-is-about-as-vanilla-as-you-can-get" class="anchor" href="#this-server-config-is-about-as-vanilla-as-you-can-get" aria-hidden="true"><span class="octicon octicon-link"></span></a>This server config is about as vanilla as you can get.</h2>

<p>after hours of making sure that it was not a "bad configuration"</p>

<p>I faithfully re-executed the command</p>

<div class="highlight highlight-bash"><pre>
$ sudo bash -c <span class="pl-s1"><span class="pl-pds">"</span><span class="pl-s1"><span class="pl-pds">$(</span>curl -fsSL https://raw.githubusercontent.com/dokku-alt/dokku-alt/master/bootstrap.sh<span class="pl-pds">)</span></span><span class="pl-pds">"</span></span>
</pre></div>

<div class="highlight highlight-bash"><pre>  My-MacBook-Pro:node-js-sample marchon$ git push dokku master

  fatal: <span class="pl-s1"><span class="pl-pds">'</span>node-js-sample<span class="pl-pds">'</span></span> does not appear to be a git repository
  fatal: Could not <span class="pl-s3">read</span> from remote repository.

  Please make sure you have the correct access rights
  and the repository exists.
</pre></div>

<p>So would appear that the repo does not exist.</p>

<p>Next task - verify which RSA Identity Keys are being used.</p>

<p>with the command</p>

<div class="highlight highlight-bash"><pre>
bash-3.2# ssh -v dokku@dokku.lazarusco.<span class="pl-k">in</span></pre></div>

<p>We can get SSH to tell us what is happening - the key information is which private key is SSH trying to use.</p>

<p>debug1: Trying private key: <strong>_/var/root/.ssh/id_rsa</strong>
debug1: read PEM private key done: type RSA
debug1: Authentication succeeded (publickey).</p>

<pre><code>
bash-3.2# ssh -v dokku@dokku.lazarusco.in
  OpenSSH_6.2p2, OSSLShim 0.9.8r 8 Dec 2011
  debug1: Reading configuration data /etc/ssh_config
  debug1: /etc/ssh_config line 20: Applying options for *
  debug1: /etc/ssh_config line 102: Applying options for *
  debug1: Connecting to dokku.lazarusco.in [172.30.42.116] port 22.
  debug1: Connection established.
  debug1: permanently_set_uid: 0/0
  debug1: identity file /var/root/.ssh/id_rsa type -1
  debug1: identity file /var/root/.ssh/id_rsa-cert type -1
  debug1: identity file /var/root/.ssh/id_dsa type -1
  debug1: identity file /var/root/.ssh/id_dsa-cert type -1
  debug1: Enabling compatibility mode for protocol 2.0
  debug1: Local version string SSH-2.0-OpenSSH_6.2
  debug1: Remote protocol version 2.0, remote software version OpenSSH_6.6.1p1 Ubuntu-2ubuntu2
  debug1: match: OpenSSH_6.6.1p1 Ubuntu-2ubuntu2 pat OpenSSH*
  debug1: SSH2_MSG_KEXINIT sent
  debug1: SSH2_MSG_KEXINIT received
  debug1: kex: server-&gt;client aes128-ctr hmac-md5-etm@openssh.com none
  debug1: kex: client-&gt;server aes128-ctr hmac-md5-etm@openssh.com none
  debug1: SSH2_MSG_KEX_DH_GEX_REQUEST(1024&lt;1024&lt;8192) sent
  debug1: expecting SSH2_MSG_KEX_DH_GEX_GROUP
  debug1: SSH2_MSG_KEX_DH_GEX_INIT sent
  debug1: expecting SSH2_MSG_KEX_DH_GEX_REPLY
  debug1: Server host key: RSA 8b:c8:61:91:4b:6e:5f:13:ea:7c:14:27:69:b0:f3:c0
  debug1: Host 'dokku.lazarusco.in' is known and matches the RSA host key.
  debug1: Found key in /var/root/.ssh/known_hosts:11
  debug1: ssh_rsa_verify: signature correct
  debug1: SSH2_MSG_NEWKEYS sent
  debug1: expecting SSH2_MSG_NEWKEYS
  debug1: SSH2_MSG_NEWKEYS received
  debug1: Roaming not allowed by server
  debug1: SSH2_MSG_SERVICE_REQUEST sent
  debug1: SSH2_MSG_SERVICE_ACCEPT received
  debug1: Authentications that can continue: publickey,password
  debug1: Next authentication method: publickey

  debug1: Trying private key: /var/root/.ssh/id_rsa

  debug1: read PEM private key done: type RSA
  debug1: Authentication succeeded (publickey).
  Authenticated to dokku.lazarusco.in ([172.30.42.116]:22).
  debug1: channel 0: new [client-session]
  debug1: Requesting no-more-sessions@openssh.com
  debug1: Entering interactive session.
  debug1: Sending environment.
  debug1: Sending env LANG = en_US.UTF-8
  Welcome to Ubuntu 14.04.2 LTS (GNU/Linux 3.16.0-30-generic x86_64)

   * Documentation:  https://help.ubuntu.com/

    System information as of Thu Feb 26 20:00:27 EST 2015

    System load:  0.0                Users logged in:        1
    Usage of /:   16.2% of 29.21GB   IP address for eth0:    172.30.42.116
    Memory usage: 7%                 IP address for docker0: 172.17.42.1
    Swap usage:   0%                 IP address for lxcbr0:  10.0.3.1
    Processes:    143

</code></pre>

<p>We have verified that</p>

<ul>
<li>SSH Connection started</li>
<li>the username is correct<br>
</li>
<li>which public/private key pair is "Actually" being used</li>
</ul>

<p>We have confirmed that it is not the ssh keys</p>

<div class="highlight highlight-bash"><pre>bash-3.2# git push dokku master
  fatal: <span class="pl-s1"><span class="pl-pds">'</span>node-js-sample<span class="pl-pds">'</span></span> does not appear to be a git repository
  fatal: Could not <span class="pl-s3">read</span> from remote repository.

  Please make sure you have the correct access rights
  and the repository exists.</pre></div>

<p>so lets push the public key again on the server so that there can be no confusion.</p>

<div class="highlight highlight-bash"><pre>
marchon@Modulo:<span class="pl-k">~</span>$ <span class="pl-s3">echo</span> <span class="pl-s1"><span class="pl-pds">"</span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC9lYDU1bxZaDCRSk7yTZqBvWy1h2vqa9haS3W2OV/16MXnuhip+/qEWDMBxb/PAWjXPDDPpoFYJBCM6C5gmLkvRa1mZsFfRP98cdDZoJHCquQDDon/GqvjQghnRt/RH8dmuMPa4MGLoXjQ4ss4xGUOuWq+OcDrUHt4MjeYoLcQIaXJRwVq9tQWPjfoe4Suv488EesE39fjcefkXCXWMkYZ+kXoYoNfW/KwzPieAGU2PdbM7E8ovWFSufAcQva1cBD69UcjjLpUEc6Nx959A0yI4Zh+iuZbBG2HbeCJMxC042985eo98SlOWLt1As9G3C4Demh8UJnoAMHoGOR1Kael root@Rhondas-MacBook-Pro.local<span class="pl-pds">"</span></span> <span class="pl-k">|</span> dokku access:add
-----<span class="pl-k">&gt;</span> e9:96:ed:cf:eb:<span class="pl-s3">fc</span>:53:2b:72:75:0f:7c:cc:ec:5f:3c added as an admin
</pre></div>

<h2>
<a id="one-last-push-to-confirm-that-i-do-not-think-it-is-a-key-problem" class="anchor" href="#one-last-push-to-confirm-that-i-do-not-think-it-is-a-key-problem" aria-hidden="true"><span class="octicon octicon-link"></span></a>One last push to confirm that I do not think it is a key problem</h2>

<div class="highlight highlight-bash"><pre>bash-3.2# git push dokku master
  fatal: <span class="pl-s1"><span class="pl-pds">'</span>node-js-sample<span class="pl-pds">'</span></span> does not appear to be a git repository
  fatal: Could not <span class="pl-s3">read</span> from remote repository.

  Please make sure you have the correct access rights
  and the repository exists.</pre></div>

<p>I created the repo on the server</p>

<div class="highlight highlight-bash"><pre>
marchon@Modulo:<span class="pl-k">~</span>$ dokku create node-js-sample
-----<span class="pl-k">&gt;</span> Application node-js-sample created<span class="pl-k">!</span>
</pre></div>

<p>and now we have a new error. ___   ! [remote rejected] master -&gt; master (pre-receive hook declined)____</p>

<div class="highlight highlight-bash"><pre>bash-3.2# git push dokku master
  Counting objects: 378, <span class="pl-k">done</span>.
  Delta compression using up to 8 threads.
  Compressing objects: 100% (307/307), <span class="pl-k">done</span>.
  Writing objects: 100% (378/378), 211.25 KiB <span class="pl-k">|</span> 0 bytes/s, <span class="pl-k">done</span>.
  Total 378 (delta 42), reused 378 (delta 42)
  remote: Access denied. No user supplied.
  To dokku@dokku.lazarusco.<span class="pl-k">in</span>:node-js-sample
   <span class="pl-k">!</span> [remote rejected] master -<span class="pl-k">&gt;</span> master (pre-receive hook declined)
  error: failed to push some refs to <span class="pl-s1"><span class="pl-pds">'</span>dokku@dokku.lazarusco.in:node-js-sample<span class="pl-pds">'</span></span>

</pre></div>

<p>at the suggestion of <a href="http://progrium.viewdocs.io/dokku/troubleshooting">http://progrium.viewdocs.io/dokku/troubleshooting</a></p>

<p>I have added to /home/dokku/dokkurc</p>

<pre><code>export DOKKU_TRACE=1
</code></pre>

<p>And now we have more debug information:</p>

<pre><code>bash-3.2# git push dokku master
  Counting objects: 378, done.
  Delta compression using up to 8 threads.
  Compressing objects: 100% (307/307), done.
  Writing objects: 100% (378/378), 211.25 KiB | 0 bytes/s, done.
  Total 378 (delta 42), reused 378 (delta 42)
  remote: +++ [[ -z /home/dokku ]]
  remote: +++++ dirname /var/lib/dokku-alt/plugins/acl/verify-command
  remote: ++++ cd /var/lib/dokku-alt/plugins/acl
  remote: ++++ pwd
  remote: +++ CWD=/var/lib/dokku-alt/plugins/acl
  remote: ++ AUTHORIZED_KEYS=/home/dokku/.ssh/authorized_keys
  remote: ++ DEPLOY_ALLOWED=DEPLOY_ALLOWED
  remote: + cat
  remote: + [[ -z '' ]]
  remote: ++ id -un
  remote: + [[ dokku != \r\o\o\t ]]
  remote: + fail 'Access denied. No user supplied.'
  remote: + echo 'Access denied. No user supplied.'
  remote: Access denied. No user supplied.
  remote: + exit 1
  To dokku@dokku.lazarusco.in:node-js-sample
   ! [remote rejected] master -&gt; master (pre-receive hook declined)
  error: failed to push some refs to 'dokku@dokku.lazarusco.in:node-js-sample'
</code></pre>

<p>and now I had to learn about <strong>SSHCOMMAND</strong></p>

<p>The documentation is not very clear - and it took me a while to wrap my head around it - but:</p>

<p>SSHCOMMAND is used to create a USERPROFILE on the server that will execute remote commands when authorized by a public/private key pair that has been authorized to execute that command.</p>

<p>This works because your Public/Private key pair is not specific to your username - but in fact will work for any user name on a machine that is willing to accept it as credentials.</p>

<p>so if we want to run a command we are going to remotely alias as LS</p>

<p>we use the following command on the server</p>

<pre><code>sshcommand create [NAME_OF_NEW_REMOTE_COMMAND] [SYNTAX]
sshcommand create LS                           "/bin/ls -lR /"
</code></pre>

<h2>
<a id="the-actual-command-syntax-for-sshcommand-create" class="anchor" href="#the-actual-command-syntax-for-sshcommand-create" aria-hidden="true"><span class="octicon octicon-link"></span></a>the actual command syntax for <strong><em>sshcommand create</em></strong>
</h2>

<div class="highlight highlight-bash"><pre>root@Modulo:<span class="pl-k">~</span># sshcommand create LS <span class="pl-s1"><span class="pl-pds">"</span>/bin/ls -lR /<span class="pl-pds">"</span></span>  </pre></div>

<p>when we use this sshcommand create it has the effect of:</p>

<ul>
<li>define a new user - called LS</li>
<li>and makes the server execute the command syntax when that user logs in</li>
</ul>

<p>Next sshcommand needs to link authorized users to these remote commands via Public/Private key pair</p>

<div class="highlight highlight-bash"><pre>
root@Modulo:<span class="pl-k">~</span># cat id_rsa.pub  <span class="pl-k">|</span>  sshcommand acl-add LS boo
  e9:96:ed:cf:eb:<span class="pl-s3">fc</span>:53:2b:72:75:0f:7c:cc:ec:5f:3c</pre></div>

<p>when ssh connects as user LS with a valid key pair the command is executed.</p>

<p>on macbook this command will login to the Server as user LS and my private key. It will then execute command and the results will stream back over the SSH chonnection</p>

<pre><code>
ssh -v LS@dokku.lazarusco.in

</code></pre>

<p>it would appear that the sshcommand bindings around the git push are incorrect.</p>

<p>But solving that is a problem for tomorrow.  </p>
      </section>
      <footer>
        <p><small>Hosted on <a href="http://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
